# Contributor: Aleksey Bobylev <al.bobylev@gmail.com>
# Maintainer: Aleksey Bobylev <al.bobylev@gmail.com>
pkgname="cdrkit"
pkgver="1.1.11"
pkgrel=0
pkgdesc="A collection of CD/DVD utilities"
url="https://en.wikipedia.org/wiki/Cdrkit" # http://www.cdrkit.org/ website is empty
arch="all"
license="GPL2"
makedepends="cmake libcap-dev zlib-dev bzip2-dev attr-dev zstd"
subpackages="$pkgname-audio $pkgname-isoinfo $pkgname-readom $pkgname-misc $pkgname-doc"
#source="http://cdrkit.org/releases/$pkgname-$pkgver.tar.gz" # website is empty
source="https://dev.alpinelinux.org/archive/cdrkit/$pkgname-$pkgver.tar.gz
	https://github.com/NixOS/nixpkgs/raw/master/pkgs/tools/cd-dvd/cdrkit/cdrkit-1.1.9-efi-boot.patch"

prepare() {
	patch -p1 -i $srcdir/cdrkit-1.1.9-efi-boot.patch
	sed -i -e '/USE_MAGIC/d' -e '/(MAGICLIBS magic)/d' "$builddir/genisoimage/CMakeLists.txt"

	# disable rcmd, it is security risk and not implemented in musl
	sed -i include/xconfig.h.in -e "s/#define HAVE_RCMD 1/#undef HAVE_RCMD/g"
}

build() {
	export LDFLAGS="$LDFLAGS -Wno-dev" # mute cmake developer warnings
	case "$CLIBC" in
		musl) export CFLAGS="$CFLAGS -D__THROW=''";;
	esac
	make PREFIX=/usr
}

package() {
	make PREFIX=/usr DESTDIR="$pkgdir" install

	# make symlinks for cdrtools compatibility
	cd "$pkgdir/usr/bin"
	ln -s genisoimage   mkhybrid
	ln -s genisoimage   mkisofs
	ln -s icedax        cdda2wav
	ln -s readom        readcd
	ln -s wodim         cdrecord

	cd "$pkgdir/usr/share/man/man1"
	ln -s genisoimage.1 mkhybrid.1
	ln -s genisoimage.1 mkisofs.1
	ln -s icedax.1      cdda2wav.1
	ln -s readom.1      readcd.1
	ln -s wodim.1       cdrecord.1
}

_split() {
	mkdir -p "$subpkgdir/usr/bin"
	for i in $@; do
		mv "$pkgdir/usr/bin/$i" "$subpkgdir/usr/bin"
	done
}

audio() {
	_split cdda2mp3 cdda2ogg cdda2wav icedax pitchplay
	pkgdesc="$pkgdesc (extracting audio files)"
}

isoinfo() {
	_split isoinfo
	pkgdesc="$pkgdesc (work with iso9660 images)"
}

readom() {
	_split readom readcd
	pkgdesc="$pkgdesc (for use with graveman)"
}

misc() {
	_split devdump dirsplit isodebug isodump isovfy readmult
	mv "$pkgdir/usr/sbin" "$subpkgdir/usr"
	pkgdesc="$pkgdesc (misc. tools)"
}

sha512sums="e5afcd2cb68d39aeff680a0d5b0a7877f94cf6de111b3cb7388261c665fbd3209ce98a20a01911875af7d6b832a156801b1fa46a4481f7c8ba60b22eac0a5b05  cdrkit-1.1.11.tar.gz
e58f0b2fcf34f865f7a9bda18b52f712530f1a3a2c64464ac1e942f558320642253fde05410d9c47e935fe6545a223d15fc8d89315f5630073016a575a45c7c8  cdrkit-1.1.9-efi-boot.patch"
