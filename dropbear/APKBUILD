# Contributor: Aleksey Bobylev <al.bobylev@gmail.com>
# Maintainer: Pascal Bellard <pascal.bellard@slitaz.org>
pkgname="dropbear"
pkgver="2018.76"
pkgrel=0
pkgdesc="Lightweight SSH2 server and client"
url="http://matt.ucc.asn.au/dropbear/dropbear.html"
arch="all"
license="MIT"
makedepends="zlib-dev linux-pam-dev"
install="$pkgname.post-install"
subpackages="$pkgname-pam:_pam $pkgname-doc"
source="http://matt.ucc.asn.au/dropbear/releases/$pkgname-$pkgver.tar.bz2
	banner
	dropbear
	sshd.pamd
	sshx
	$pkgname.post-install
	$pkgname.post-deinstall"
options="!check"
provide="ssh"
_dropbears="dbclient dropbearkey dropbearconvert scp"


build() {
	# version without PAM support
	sed -e 's|/usr/.*/xauth|/usr/bin/xauth|' \
		-e 's|ENABLE_SVR_PAM_AUTH|ENABLE_SVR_PASSWORD_AUTH|' \
		-iold options.h
	./configure \
		--prefix=/usr \
		--without-pam
	make PROGRAMS="dropbear $_dropbears" MULTI=1 SCPPROGRESS=1
	mv dropbearmulti dropbearmulti-1

	# version with PAM support
	sed -i 's|ENABLE_SVR_PASSWORD_AUTH|ENABLE_SVR_PAM_AUTH|' options.h
	make clean
	./configure \
		--prefix=/usr \
		--enable-pam
	make PROGRAMS="dropbear $_dropbears" MULTI=1 SCPPROGRESS=1
}

package() {
	install -Dm755 dropbearmulti-1 "$pkgdir/usr/sbin/dropbear"
	install -Dm755 dropbearmulti   "$pkgdir/usr/sbin/dropbear-pam"

	install -dm755 "$pkgdir/usr/bin"
	for i in $_dropbears ssh; do
		ln -s ../sbin/dropbear "$pkgdir/usr/bin/$i"
	done

	# Config file and init script.
	install -Dm644 "$srcdir/banner"   "$pkgdir/etc/dropbear/banner"
	install -Dm755 "$srcdir/dropbear" "$pkgdir/etc/init.d/dropbear"
	install -Dm755 "$srcdir/sshx"     "$pkgdir/usr/bin/sshx"
	ln -s sshx "$pkgdir/usr/bin/pppssh"
	ln -s sshx "$pkgdir/usr/bin/sshfbvnc"
	touch "$pkgdir/etc/dropbear/dropbear_dss_host_key" \
	      "$pkgdir/etc/dropbear/dropbear_rsa_host_key" \
	      "$pkgdir/etc/dropbear/dropbear_ecdsa_host_key"

	# PAM
	install -Dm644 "$srcdir/sshd.pamd" "$pkgdir/etc/pam.d/sshd"

	ln -s daemon "$pkgdir/etc/init.d/sshd"

	mkdir -p "$pkgdir/usr/share/man/man1" "$pkgdir/usr/share/man/man8"
	cp "$builddir"/*.1 "$pkgdir/usr/share/man/man1"
	cp "$builddir"/*.8 "$pkgdir/usr/share/man/man8"

	docdir="$pkgdir/usr/share/doc/$pkgname-$pkgver"
	mkdir -p "$docdir"
	cp CHANGES INSTALL LICENSE MULTI README SMALL "$docdir"
}

_pam() {
	mkdir -p "$subpkgdir/usr/sbin" "$subpkgdir/etc"
	mv "$pkgdir/usr/sbin/dropbear-pam" "$subpkgdir/usr/sbin/dropbear"
	mv "$pkgdir/etc/pam.d" "$subpkgdir/etc"

	pkgdesc="$pkgdesc (with PAM support)"
	replaces="$pkgname"
	install_if="linux-pam $pkgname"
}

sha512sums="82323279f7e78c366ba1ea07ff242259132b2576122429f54326518dd6092aba8ae5de4a0b8a3cef7efc3507015741abe2ac23376c03b40b247527da7a88120e  dropbear-2018.76.tar.bz2
018623db1a9e35d1c54eb4c2a41c155545089d96cac6ac010ab764b5cd56ebb1fe16699e1e8edea415ab1379246fa82a3e98fd44a142495e9bc2cd8b4c23bce4  banner
c04953eb2f8e42868599c3255ed538cf04fa18f629f69331d98b52e887598de723d24b542c6bc799d33758d8a0f93395f24d0ddfe3e1dda05eb400a6828aae86  dropbear
9dbad3f4f223c39e0d9d864cbb59310e1613c198fe319533e7c4e87f9252a764abda3f75f7e25bd265e65e77694a7de3f0259360041d58932462ba3583c6bbc9  sshd.pamd
4315cddcf14fbfc0d4d3ac0ec75c425c56864b1c773f2b1e92f23a0758a3e2948f1e591feab4b7502d02727ea4310ea8671cc7557627221f1abb5c2f818e88cc  sshx
5eff9e1b25add4552a44b1bd23f8049e3c1107c1a2f47c2bd09a6e14b2f043b4ebf27f72646ba9d49f95176ac9b9ee63bf1f843ad4519ff93c4c479706679118  dropbear.post-install
99eb70c82fd305d77ce6d32e0345c3d6bbc4ed8d14e3fd26d937163d65b6a4a847d570ebd4dcb665928452227a2619c5198af57da46974b8e9a7c5434326505c  dropbear.post-deinstall"
